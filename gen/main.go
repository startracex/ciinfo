//go:generate go run main.go
package main

import (
	"bytes"
	"encoding/json"
	"fmt"
	"go/format"
	"os"
	"path/filepath"

	"github.com/startracex/ciinfo/vendors"
)

func main() {
	root := ".."
	data, err := os.ReadFile(filepath.Join(root, "node_modules/ci-info/vendors.json"))

	if err != nil {
		panic("ci-info npm package is not installed")
	}

	var vs []vendors.Vendor
	mayPanic(json.Unmarshal(data, &vs))

	var buf bytes.Buffer

	buf.WriteString(`// Code generated by go generate; DO NOT EDIT
package vendors

import (
	"github.com/startracex/ciinfo/syntax"
)
`)

	buf.WriteString("var (\n")
	for _, rv := range vs {
		fmt.Fprintf(&buf, "Vendor%s = Vendor{", rv.Constant)

		fmt.Fprintf(&buf, "Name:%q, Constant:%q,", rv.Name, rv.Constant)

		buf.WriteString("Env: syntax.EnvList{")
		for _, e := range rv.Env {
			fmt.Fprintf(&buf,
				"{StrictEqual:%q, Includes:%q, EqualsAnyOf:%#v, EqualsMap:%#v},",
				e.StrictEqual, e.Includes, e.EqualsAnyOf, e.EqualsMap)
		}
		buf.WriteString("},")

		if rv.PR != nil {
			pr := rv.PR
			fmt.Fprintf(&buf,
				"PR: &syntax.PR{StrictEqual:%q, NotEqual:%q, EqualsAnyOf:%#v, EqualsMap:%#v},",
				pr.StrictEqual, pr.NotEqual, pr.EqualsAnyOf, pr.EqualsMap)
		} else {
			buf.WriteString("PR:nil,")
		}

		buf.WriteString("}\n")
	}

	buf.WriteString("All = []Vendor{")
	for _, rv := range vs {
		fmt.Fprintf(&buf, "Vendor%s,", rv.Constant)
	}
	buf.WriteString("}\n")

	buf.WriteString(")\n")

	out, err := format.Source(buf.Bytes())
	mayPanic(err)

	mayPanic(os.WriteFile(filepath.Join(root, "/vendors/vendors_gen.go"), out, 0644))
}

func mayPanic(err error) {
	if err != nil {
		panic(err)
	}
}
